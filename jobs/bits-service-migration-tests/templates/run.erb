#!/bin/bash -l

set -e -x

export GOROOT=$(readlink -nf /var/vcap/packages/golang1.7)
export PATH=${GOROOT}/bin:${PATH}

export PATH=/var/vcap/packages/cli/bin:${PATH} # put the cli on the path

export GOPATH=/var/vcap/packages/bits-service-migration-tests
export PATH=${GOPATH}/bin:${PATH}

export CF_COLOR=false
export CONFIG=/var/vcap/jobs/bits-service-migration-tests/bin/config.json

mkdir -p /var/vcap/sys/log/bits-service-migration-tests
rm -rf /var/vcap/sys/log/bits-service-migration-tests/*

cd /var/vcap/packages/bits-service-migration-tests/src/github.com/cloudfoundry-incubator/bits-service-migration-tests

echo '################################################################################################################'
echo $(go version)
echo CONFIG=$CONFIG
env | sort
echo '################################################################################################################'

echo "Running BSMT tests..."

EXITSTATUS=0

verbose=<%= properties.acceptance_tests.verbose ? "-v" : "" %>
noColorFlag=<%= properties.acceptance_tests.enable_color ? "" : "-noColor" %>

set +e
bin/test -r $noColorFlag -slowSpecThreshold=120 -randomizeAllSpecs $verbose \
  -keepGoing <%= properties.bits_service_migration_tests.test_suite %> \
  > /var/vcap/sys/log/bits-service-migration-tests.log \
  2> /var/vcap/sys/log/bits-service-migration-tests.err.log
EXITSTATUS=$?
set -e
tail -c 991232 /var/vcap/sys/log/bits-service-migration-tests.log

echo "BSMT Tests Complete; exit status: $EXITSTATUS"

for i in /var/vcap/sys/log/bits-service-migration-tests/*; do
  if [ -e "$i" ]
  then
    mv $i $i.log # needed to make download-logs work
  fi
done

exit $EXITSTATUS
